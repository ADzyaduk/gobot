// Package main is the entry point for the Telegram bot application
package main

import (
	"log"
	"os"
	"os/signal"
	"syscall"

	"gobot/internal/bot"
	"gobot/internal/config"
	"gobot/internal/database"
)

func main() {
	// Load configuration
	cfg, err := config.Load()
	if err != nil {
		log.Fatalf("Failed to load configuration: %v", err)
	}

	log.Println("Configuration loaded successfully")

	// Initialize database
	if err := database.Initialize(cfg.DBPath, cfg.Debug); err != nil {
		log.Fatalf("Failed to initialize database: %v", err)
	}
	defer database.Close()

	// Create initial data if needed
	if err := seedDatabase(); err != nil {
		log.Printf("Warning: Failed to seed database: %v", err)
	}

	// Create and start bot
	telegramBot, err := bot.New(cfg)
	if err != nil {
		log.Fatalf("Failed to create bot: %v", err)
	}

	// Handle graceful shutdown
	go func() {
		sigChan := make(chan os.Signal, 1)
		signal.Notify(sigChan, os.Interrupt, syscall.SIGTERM)
		<-sigChan
		log.Println("Shutting down bot...")
		telegramBot.Stop()
		os.Exit(0)
	}()

	// Start bot
	log.Println("Starting bot...")
	telegramBot.Start()
}

// seedDatabase creates initial services if they don't exist
func seedDatabase() error {
	var count int64
	database.DB.Model(&database.Service{}).Count(&count)

	if count > 0 {
		log.Println("Database already seeded")
		return nil
	}

	log.Println("Seeding database with initial services...")

	services := []database.Service{
		// Массаж
		{
			Name:                "Общий массаж тела 60 мин",
			Duration:            60,
			Price:               250000, // 2500 руб.
			Description:         "Общеукрепляющий массаж всего тела",
			DetailedDescription: "Общий массаж тела - это комплексная процедура, направленная на улучшение общего состояния организма. Включает в себя проработку всех основных групп мышц, улучшение кровообращения и лимфотока, снятие мышечного напряжения и усталости. Подходит для всех возрастов и уровней физической активности.",
			IsActive:            true,
		},
		{
			Name:                "Общий массаж тела 90 мин",
			Duration:            90,
			Price:               300000, // 3000 руб.
			Description:         "Расширенный массаж всего тела",
			DetailedDescription: "Общий массаж тела продолжительностью 90 минут - это более глубокий и детальный массаж всех зон тела. Позволяет более тщательно проработать проблемные участки, снять глубокое мышечное напряжение и обеспечить максимальное расслабление. Идеально подходит для тех, кто испытывает сильное напряжение или хочет получить более длительный эффект релаксации.",
			IsActive:            true,
		},
		{
			Name:                "Массаж спины 30 мин",
			Duration:            30,
			Price:               150000, // 1500 руб.
			Description:         "Целевой массаж спины и плечевого пояса",
			DetailedDescription: "Массаж спины направлен на снятие напряжения в области позвоночника, плечевого пояса и шеи. Особенно эффективен при болях в спине, скованности движений и сидячем образе жизни. Помогает улучшить осанку, снять мышечные спазмы и восстановить подвижность.",
			IsActive:            true,
		},
		{
			Name:                "Антицеллюлитный массаж",
			Duration:            60,
			Price:               220000, // 2200 руб.
			Description:         "Специализированный массаж для коррекции фигуры",
			DetailedDescription: "Антицеллюлитный массаж - это интенсивная техника массажа, направленная на улучшение состояния кожи, уменьшение проявлений целлюлита и коррекцию фигуры. Стимулирует кровообращение, лимфоток и обменные процессы в тканях. Регулярные процедуры помогают сделать кожу более упругой и гладкой.",
			IsActive:            true,
		},
		{
			Name:                "Лимфодренажный массаж",
			Duration:            60,
			Price:               220000, // 2200 руб.
			Description:         "Мягкий массаж для улучшения лимфотока",
			DetailedDescription: "Лимфодренажный массаж - это деликатная техника, направленная на активацию лимфатической системы. Помогает вывести лишнюю жидкость из организма, уменьшить отеки, улучшить обмен веществ и укрепить иммунитет. Особенно рекомендуется при отечности, чувстве тяжести в ногах и для общего оздоровления организма.",
			IsActive:            true,
		},
		{
			Name:                "Массаж лица 50 мин",
			Duration:            50,
			Price:               220000, // 2200 руб.
			Description:         "Омолаживающий массаж лица",
			DetailedDescription: "Массаж лица - это эффективная процедура для поддержания молодости и красоты кожи. Улучшает кровообращение, тонизирует мышцы лица, способствует разглаживанию морщин и улучшению цвета лица. Регулярные процедуры помогают замедлить процессы старения и поддерживать кожу в отличном состоянии.",
			IsActive:            true,
		},
		// Комплексы
		{
			Name:                "Массаж тело + лицо 2 часа",
			Duration:            120,
			Price:               390000, // 3900 руб.
			Description:         "Комплексный массаж всего тела и лица",
			DetailedDescription: "Комплексная процедура включает общий массаж всего тела и массаж лица. Это идеальное решение для полного расслабления и восстановления. Массаж тела снимает напряжение во всем организме, а массаж лица обеспечивает уход за кожей лица, улучшая ее состояние и внешний вид. Рекомендуется для полного восстановления и релаксации.",
			IsActive:            true,
		},
		{
			Name:                "Массаж спина + лицо 1 час",
			Duration:            60,
			Price:               220000, // 2200 руб.
			Description:         "Комплексный массаж спины и лица",
			DetailedDescription: "Комплексная процедура включает массаж спины и массаж лица. Идеально подходит для тех, кто испытывает напряжение в области спины и хочет одновременно позаботиться о коже лица. Массаж спины снимает мышечное напряжение, а массаж лица обеспечивает уход и омоложение кожи.",
			IsActive:            true,
		},
		// Уход за лицом
		{
			Name:                "Очищение (УЗ чистка + маска + уход)",
			Duration:            60,
			Price:               190000, // 1900 руб.
			Description:         "Комплексное очищение кожи лица",
			DetailedDescription: "Процедура включает ультразвуковую чистку лица, нанесение маски и завершающий уход. УЗ-чистка эффективно удаляет загрязнения, черные точки и отмершие клетки кожи без повреждения. Маска питает и увлажняет кожу, а завершающий уход закрепляет результат. Подходит для всех типов кожи.",
			IsActive:            true,
		},
		{
			Name:                "Глубокое очищение (УЗ чистка + пилинг + маска + уход)",
			Duration:            90,
			Price:               330000, // 3300 руб.
			Description:         "Интенсивное глубокое очищение кожи",
			DetailedDescription: "Процедура глубокого очищения включает ультразвуковую чистку, пилинг, маску и завершающий уход. Пилинг дополнительно отшелушивает омертвевшие клетки, делая кожу более гладкой и сияющей. Идеально подходит для проблемной кожи, склонной к высыпаниям и черным точкам. Результат - чистая, гладкая и сияющая кожа.",
			IsActive:            true,
		},
		{
			Name:                "Антивозрастной уход (Пилинг + концентрат + маска + уход)",
			Duration:            90,
			Price:               310000, // 3100 руб.
			Description:         "Комплексный антивозрастной уход",
			DetailedDescription: "Антивозрастной уход включает пилинг для обновления кожи, нанесение концентрата с активными компонентами против старения, маску для глубокого питания и завершающий уход. Процедура направлена на разглаживание морщин, улучшение упругости кожи, выравнивание тона и текстуры. Результат - более молодая, подтянутая и сияющая кожа.",
			IsActive:            true,
		},
		{
			Name:                "Осветляющий уход (Пилинг + концентрат + маска)",
			Duration:            75,
			Price:               310000, // 3100 руб.
			Description:         "Осветляющий уход для ровного тона кожи",
			DetailedDescription: "Осветляющий уход включает пилинг для обновления кожи, нанесение осветляющего концентрата и маску. Процедура направлена на выравнивание тона кожи, осветление пигментных пятен и постакне, придание коже ровного и сияющего вида. Идеально подходит для кожи с неравномерным тоном и пигментацией.",
			IsActive:            true,
		},
		{
			Name:                "Маска (альгинатная, по типу кожи)",
			Duration:            30,
			Price:               50000, // 500 руб.
			Description:         "Альгинатная маска для лица",
			DetailedDescription: "Альгинатная маска подбирается индивидуально по типу кожи. Создает эффект лифтинга, увлажняет, питает и тонизирует кожу. Маска наносится на лицо и застывает, создавая эффект сауны, что способствует лучшему проникновению активных компонентов. Подходит как самостоятельная процедура или дополнение к другим уходам.",
			IsActive:            true,
		},
	}

	for _, service := range services {
		if err := database.DB.Create(&service).Error; err != nil {
			return err
		}
	}

	log.Println("Database seeded successfully")
	return nil
}
